name: Build Android APK

on:
  push:
    branches:
      - main
      - master
      - dev-ui-overhaul

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      - name: Run Tests
        run: npm run test:run

      - name: Patch broken dependencies (Proguard & JCenter fix)
        run: |
          find node_modules -name "build.gradle" -exec sed -i 's/proguard-android.txt/proguard-android-optimize.txt/g' {} +
          find node_modules -name "build.gradle" -exec sed -i 's/jcenter()/mavenCentral()/g' {} +


      - name: Build Web Assets
        run: npm run build

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Setup Permanent Keystore
        run: |
          mkdir -p ~/.config/.android
          cp android/debug.keystore ~/.config/.android/debug.keystore

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Build APK with Gradle
        working-directory: android
        run: ./gradlew assembleDebug

      - name: Extract version from package.json
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Rename APK
        run: |
          if [ "${{ github.ref_name }}" == "main" ] || [ "${{ github.ref_name }}" == "master" ]; then
            mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/vitemonjager-${{ env.APP_VERSION }}.apk
            echo "APK_NAME=vitemonjager-${{ env.APP_VERSION }}.apk" >> $GITHUB_ENV
            echo "RELEASE_TAG=v${{ env.APP_VERSION }}" >> $GITHUB_ENV
            echo "RELEASE_NAME=JÃ¤ger Tracker v${{ env.APP_VERSION }}" >> $GITHUB_ENV
            echo "IS_LATEST=true" >> $GITHUB_ENV
          else
            mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/vitemonjager-dev.apk
            echo "APK_NAME=vitemonjager-dev.apk" >> $GITHUB_ENV
            echo "RELEASE_TAG=dev-latest" >> $GITHUB_ENV
            echo "RELEASE_NAME=JÃ¤ger Tracker (DEV BUILD)" >> $GITHUB_ENV
            echo "IS_LATEST=false" >> $GITHUB_ENV
          fi

      - name: Create Release and Upload APK
        uses: ncipollo/release-action@v1
        with:
          artifacts: "android/app/build/outputs/apk/debug/${{ env.APK_NAME }}"
          tag: "${{ env.RELEASE_TAG }}"
          name: "${{ env.RELEASE_NAME }}"
          body: |
            ## Build from branch: ${{ github.ref_name }}
            This is an automated build for testing purposes.
            
            [View Full Changelog](https://github.com/Areakend/VMJ/blob/main/CHANGELOG.md)
            
            Cheers! ðŸ¥‚
          allowUpdates: true
          makeLatest: ${{ env.IS_LATEST }}
